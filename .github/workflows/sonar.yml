name: C++ SonarCloud Analysis (CMake/Linux)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    name: SonarCloud Scan
    # ✅ Ключевое изменение: используем Linux (ubuntu)
    runs-on: ubuntu-latest
    
    env:
      BUILD_DIR: build_sonar
      BUILD_WRAPPER_OUTPUT: bw_output
      # Указываем Sonar, где искать исходники (корневой каталог)
      SONAR_SOURCES: . 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Устанавливаем Build Wrapper
      - name: Install Build Wrapper
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v4
        
      - name: Install Qt Dependencies
        run: |
          sudo apt-get update
          # Устанавливаем необходимые пакеты для сборки Qt-приложений на Linux
          sudo apt-get install -y qt6-base-dev cmake
          
      # 1. СБОРКА: Настраиваем CMake и запускаем Build Wrapper
      - name: Run CMake and Build Wrapper
        run: |
          echo "Starting CMake build and wrapping process..."
          rm -rf ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.BUILD_DIR }}
          
          # 1. Настройка CMake
          cmake -S . -B ${{ env.BUILD_DIR }}
          
          # 2. Запуск Build Wrapper для отслеживания сборки
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUTPUT }} cmake --build ${{ env.BUILD_DIR }} --config Release
          
          echo "Build Wrapper successfully created output."

      # 2. АНАЛИЗ: Запуск Sonar Scanner
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=kursach
            -Dsonar.cfamily.build-wrapper-output=${{ env.BUILD_WRAPPER_OUTPUT }}
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.sources=${{ env.SONAR_SOURCES }}
