name: C++ SonarCloud Analysis (CMake/Linux)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    name: SonarCloud Scan
    # âœ… ÐšÐ»ÑŽÑ‡ÐµÐ²Ð¾Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Linux (ubuntu)
    runs-on: ubuntu-latest
  
    env:
      BUILD_DIR: build_sonar
      BUILD_WRAPPER_OUTPUT: bw_output
      # Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Sonar, Ð³Ð´Ðµ Ð¸ÑÐºÐ°Ñ‚ÑŒ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ¸ (ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³)
      SONAR_SOURCES: . 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Build Wrapper
      - name: Install Build Wrapper
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v4
        
      - name: Install Qt Dependencies
        run: |
          sudo apt-get update
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Qt-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ Ð½Ð° Linux
          sudo apt-get install -y qt6-base-dev cmake
          
      # 1. Ð¡Ð‘ÐžÐ ÐšÐ: ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ CMake Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Build Wrapper
      - name: Run CMake and Build Wrapper
        run: |
          echo "Starting CMake build and wrapping process..."
          rm -rf ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.BUILD_DIR }}
          
          # 1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° CMake
          cmake -S . -B ${{ env.BUILD_DIR }}
          
          # 2. Ð—Ð°Ð¿ÑƒÑÐº Build Wrapper Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUTPUT }} cmake --build ${{ env.BUILD_DIR }} --config Release
          
          echo "Build Wrapper successfully created output."

     # 2. ÐÐÐÐ›Ð˜Ð—: Ð—Ð°Ð¿ÑƒÑÐº Sonar Scanner
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ðŸ’¡ Ð’Ð¡Ð¢ÐÐ’Ð¬Ð¢Ð• Ð¡Ð®Ð”Ð Ð¡Ð’ÐžÐ™ Ð¢ÐžÐšÐ•Ð ÐŸÐ ÐžÐ•ÐšÐ¢Ð:
          PROJECT_TOKEN: 35aa0105af98d09b5c5973b5966a0a6e9a03dbf2 
        with:
          args: >
            -Dsonar.organization=volkovich81 
            -Dsonar.projectKey=kursach
            -Dsonar.cfamily.build-wrapper-output=${{ env.BUILD_WRAPPER_OUTPUT }}
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.sources=${{ env.SONAR_SOURCES }}
            -Dsonar.branch.name=main
            -Dsonar.branch.type=long
            -Dsonar.token=${{ env.PROJECT_TOKEN }}
