name: C++ SonarCloud Analysis (CMake/Linux)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    name: SonarCloud Scan
    runs-on: ubuntu-latest

    env:
      BUILD_DIR: build_sonar
      BUILD_WRAPPER_OUTPUT: bw_output
      SONAR_SOURCES: . 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Build Wrapper
        # –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å–∞–º–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç build-wrapper –∏ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –≤ PATH
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v4

      - name: Install Qt Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qt6-base-dev cmake

      # 1. –°–ë–û–†–ö–ê: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º CMake –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Build Wrapper
      - name: Run CMake and Build Wrapper
        run: |
          echo "Starting CMake build and wrapping process..."
          rm -rf ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.BUILD_DIR }}

          # 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CMake
          cmake -S . -B ${{ env.BUILD_DIR }}

          # 2. –ó–∞–ø—É—Å–∫ Build Wrapper –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–±–æ—Ä–∫–∏
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUTPUT }} cmake --build ${{ env.BUILD_DIR }} --config Release

          echo "Build Wrapper successfully created output."

      # 2. –ê–ù–ê–õ–ò–ó: –ó–∞–ø—É—Å–∫ Sonar Scanner
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_TOKEN: 35aa0105af98d09b5c5973b5966a0a6e9a03dbf2 
        with:
          args: >
            -Dsonar.organization=volkovich81 
            -Dsonar.projectKey=kursach
            -Dsonar.cfamily.build-wrapper-output=${{ env.BUILD_WRAPPER_OUTPUT }}
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.sources=${{ env.SONAR_SOURCES }}
            -Dsonar.branch.name=main
            -Dsonar.branch.type=long
            -Dsonar.token=${{ env.PROJECT_TOKEN }}
            # üí° –ù–û–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–¢–ö–õ–Æ–ß–ê–ï–ú –ü–†–û–í–ï–†–ö–£ ALM
            -Dsonar.scm.disabled=true
