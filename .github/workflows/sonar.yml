name: C++ SonarCloud Analysis (CMake/Linux)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    name: SonarCloud Scan
    runs-on: ubuntu-latest

    env:
      BUILD_DIR: build_sonar
      BUILD_WRAPPER_OUTPUT: bw_output
      SONAR_SOURCES: . 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Build Wrapper
        # Это действие само устанавливает build-wrapper и делает его доступным в PATH
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v4

      - name: Install Qt Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qt6-base-dev cmake

      # 1. СБОРКА: Настраиваем CMake и запускаем Build Wrapper
      - name: Run CMake and Build Wrapper
        run: |
          echo "Starting CMake build and wrapping process..."
          rm -rf ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.BUILD_DIR }}

          # 1. Настройка CMake
          cmake -S . -B ${{ env.BUILD_DIR }}

          # 2. Запуск Build Wrapper для отслеживания сборки
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUTPUT }} cmake --build ${{ env.BUILD_DIR }} --config Release
          ls -l ${{ env.BUILD_WRAPPER_OUTPUT }}/compile_commands.json
          echo "Build Wrapper successfully created output."

      # 2. АНАЛИЗ: Установка и запуск SonarScanner CLI
      - name: SonarCloud Scan (Manual CLI)
        run: |
          # 1. Скачивание и распаковка SonarScanner CLI
          SONAR_SCANNER_CLI_URL="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip"
          SONAR_SCANNER_DIR="sonar-scanner"
          
          mkdir -p ${SONAR_SCANNER_DIR}
          wget -q -O /tmp/sonarscanner.zip ${SONAR_SCANNER_CLI_URL}
          unzip -q /tmp/sonarscanner.zip -d ${SONAR_SCANNER_DIR}
          
          # Находим бинарник (он будет в поддиректории)
          SONAR_RUNNER=$(find ${SONAR_SCANNER_DIR} -name "sonar-scanner" | head -n 1)

          echo "Scanner found at: ${SONAR_RUNNER}"
          
          # 2. Запуск сканирования
          ${SONAR_RUNNER} \
            -Dsonar.organization=volkovich81 \
            -Dsonar.projectKey=kursach \
            -Dsonar.token=35aa0105af98d09b5c5973b5966a0a6e9a03dbf2 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.cfamily.build-wrapper-output=${{ env.BUILD_WRAPPER_OUTPUT }} \
            -Dsonar.sources=${{ env.SONAR_SOURCES }} \
            -Dsonar.scm.disabled=true
