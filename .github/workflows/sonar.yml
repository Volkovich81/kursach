name: C++ SonarCloud Analysis (CMake/Linux)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    name: SonarCloud Scan
    # ‚úÖ –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ–º Linux (ubuntu)
    runs-on: ubuntu-latest
    
    env:
      BUILD_DIR: build_sonar
      BUILD_WRAPPER_OUTPUT: bw_output
      # –£–∫–∞–∑—ã–≤–∞–µ–º Sonar, –≥–¥–µ –∏—Å–∫–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ (–∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥)
      SONAR_SOURCES: . 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Build Wrapper
      - name: Install Build Wrapper
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v4
        
      - name: Install Qt Dependencies
        run: |
          sudo apt-get update
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ Qt-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ Linux
          sudo apt-get install -y qt6-base-dev cmake
          
      # 1. –°–ë–û–†–ö–ê: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º CMake –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Build Wrapper
      - name: Run CMake and Build Wrapper
        run: |
          echo "Starting CMake build and wrapping process..."
          rm -rf ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.BUILD_DIR }}
          
          # 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CMake
          cmake -S . -B ${{ env.BUILD_DIR }}
          
          # 2. –ó–∞–ø—É—Å–∫ Build Wrapper –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–±–æ—Ä–∫–∏
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUTPUT }} cmake --build ${{ env.BUILD_DIR }} --config Release
          
          echo "Build Wrapper successfully created output."

     # 2. –ê–ù–ê–õ–ò–ó: –ó–∞–ø—É—Å–∫ Sonar Scanner (–° –î–û–ë–ê–í–õ–ï–ù–ò–ï–ú –ì–õ–ê–í–ù–û–ô –í–ï–¢–ö–ò)
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=kursach
            -Dsonar.cfamily.build-wrapper-output=${{ env.BUILD_WRAPPER_OUTPUT }}
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.sources=${{ env.SONAR_SOURCES }}
            # üí° –ù–û–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –£–ö–ê–ó–´–í–ê–ï–ú –ì–õ–ê–í–ù–£–Æ –í–ï–¢–ö–£ –ü–†–ò –ü–ï–†–í–û–ú –ó–ê–ü–£–°–ö–ï
            -Dsonar.branch.name=main
            -Dsonar.branch.target=main
