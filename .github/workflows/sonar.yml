name: C++ SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java for SonarScanner
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup MSBuild (Visual Studio build environment)
        uses: microsoft/setup-msbuild@v2

      # 1. СКАЧИВАНИЕ И УСТАНОВКА ИНСТРУМЕНТОВ
      - name: Download Build Wrapper and Sonar Scanner
        id: setup_tools
        run: |
          # 1. BUILD WRAPPER: Скачивание, 7z-распаковка и перемещение в bw.exe
          $bw_url = "https://sonarcloud.io/static/cpp/build-wrapper-win-x86.zip"
          Invoke-WebRequest -Uri $bw_url -OutFile build-wrapper.zip
          & "C:\Program Files\7-Zip\7z.exe" x build-wrapper.zip -o"build-wrapper-temp" -y
          
          $foundFiles = Get-ChildItem -Path build-wrapper-temp -Recurse -File
          if ($foundFiles.Count -ne 1) { throw "Unexpected number of files in wrapper zip." }
          
          Move-Item -Path $foundFiles[0].FullName -Destination "bw.exe" -Force
          if (-not (Test-Path "bw.exe")) { throw "Move failed." }
          
          Write-Host "BW_PATH=bw.exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          # 2. SONAR SCANNER CLI: Скачивание и 7z-распаковка
          $scanner_url = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip"
          Invoke-WebRequest -Uri $scanner_url -OutFile sonar-scanner.zip
          & "C:\Program Files\7-Zip\7z.exe" x sonar-scanner.zip -o"." -y
          
          # ✅ КОРРЕКТНЫЙ ПОИСК SONAR SCANNER: Ищем папку, содержащую "sonar-scanner-"
          $scannerDir = Get-ChildItem -Path . -Filter "sonar-scanner-*" -Directory | Select-Object -First 1
          
          if ($scannerDir -eq $null) { throw "Sonar Scanner directory not found. Check if the directory name changed." }
          Write-Host "SCANNER_PATH=$($scannerDir.FullName)\bin\sonar-scanner.bat" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # 2. ШАГ СБОРКИ: Запуск Build Wrapper и MSBuild
      - name: Run Build Wrapper and MSBuild
        run: |
          # ПУТЬ БЕРЕТСЯ ИЗ ПРЕДЫДУЩЕГО ШАГА!
          $bwPath = "${{ steps.setup_tools.outputs.BW_PATH }}"
          
          # Запускаем Build Wrapper для отслеживания MSBuild
          & "$bwPath" --out-dir bw-output msbuild kursach.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64
          
      # 3. ШАГ ОТПРАВКИ: Запуск анализа Sonar Scanner
      - name: SonarScanner Analysis
        run: |
          $scannerPath = "${{ steps.setup_tools.outputs.SCANNER_PATH }}"
          
          # Запускаем анализ
          & "$scannerPath" `
            -Dsonar.host.url=https://sonarcloud.io `
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} `
            -Dsonar.projectKey=kursach `
            -Dsonar.cfamily.build-wrapper-output=bw-output `
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
