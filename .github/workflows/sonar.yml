name: C++ SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º Windows, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç MSBuild
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java for SonarScanner
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup MSBuild (Visual Studio build environment)
        uses: microsoft/setup-msbuild@v2

      # 1. –°–ö–ê–ß–ò–í–ê–ù–ò–ï –ò –£–°–¢–ê–ù–û–í–ö–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í –í–†–£–ß–ù–£–Æ
      - name: Download Build Wrapper and Sonar Scanner
        id: setup_tools
        run: |
          # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Build Wrapper
          $bw_url = "https://sonarcloud.io/static/cpp/build-wrapper-win-x86.zip"
          Invoke-WebRequest -Uri $bw_url -OutFile build-wrapper.zip
          Expand-Archive -Path build-wrapper.zip -DestinationPath . -Force
          
          # üö® –û–¢–õ–ê–î–ö–ê: –í–´–í–û–î–ò–ú –í–°–ï –ü–£–¢–ò
          Write-Host "--- DEBUG: ALL FILES IN REPO ---"
          # –í—ã–≤–æ–¥–∏–º –≤—Å–µ —Ñ–∞–π–ª—ã —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ build-wrapper.exe
          Get-ChildItem -Path . -Recurse | Select-Object FullName
          Write-Host "--- END DEBUG ---"
          
          # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—à–µ–ª –¥–∞–ª—å—à–µ
          $wrapperPath = "" # –ú—ã –Ω–∞–π–¥–µ–º –µ–≥–æ –≤—Ä—É—á–Ω—É—é
          if ($wrapperPath -eq "") { throw "DEBUG MODE: Path will be copied manually from output above." }
          
          # –û—Å—Ç–∞–≤—à–∞—è—Å—è —á–∞—Å—Ç—å –∫–æ–¥–∞ (–¥–ª—è Sonar Scanner)
          $scanner_url = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip"
          Invoke-WebRequest -Uri $scanner_url -OutFile sonar-scanner.zip
          Expand-Archive -Path sonar-scanner.zip -DestinationPath . -Force
          
          $scannerDir = Get-ChildItem -Path . -Filter "sonar-scanner-cli-*" -Directory | Select-Object -First 1
          if ($scannerDir -eq $null) { throw "Sonar Scanner directory not found." }
          Write-Host "SCANNER_PATH=$($scannerDir.FullName)\bin\sonar-scanner.bat" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      
      # 2. –®–ê–ì –°–ë–û–†–ö–ò: –ó–∞–ø—É—Å–∫ Build Wrapper –∏ MSBuild
      - name: Run Build Wrapper and MSBuild
        run: |
          $bwPath = "${{ steps.setup_tools.outputs.BW_PATH }}"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º Build Wrapper –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è MSBuild
          & "$bwPath" --out-dir bw-output msbuild kursach.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64

      # 3. –®–ê–ì –û–¢–ü–†–ê–í–ö–ò: –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
      - name: SonarScanner Analysis
        run: |
          $scannerPath = "${{ steps.setup_tools.outputs.SCANNER_PATH }}"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
          & "$scannerPath" `
            -Dsonar.host.url=https://sonarcloud.io `
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} `
            -Dsonar.projectKey=kursach `
            -Dsonar.cfamily.build-wrapper-output=bw-output `
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
