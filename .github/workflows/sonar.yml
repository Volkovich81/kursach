name: C++ SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java for SonarScanner
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup MSBuild (Visual Studio build environment)
        uses: microsoft/setup-msbuild@v2

      - name: Download Build Wrapper
        id: find_wrapper
        run: |
          $url = "https://sonarcloud.io/static/cpp/build-wrapper-win-x86.zip"
          Write-Host "Downloading Build Wrapper from $url"
          Invoke-WebRequest -Uri $url -OutFile build-wrapper.zip

          # 1. Распаковываем в папку 'bw-temp'
          Expand-Archive -Path build-wrapper.zip -DestinationPath bw-temp -Force

          # 2. Выводим все содержимое для отладки
          Write-Host "Listing contents of bw-temp:"
          Get-ChildItem -Path bw-temp -Recurse | Select-Object FullName

          # 3. ИСПОЛЬЗУЕМ Get-ChildItem С ПОЛНОЙ ПАПКОЙ (самый надежный путь)
          # Это предполагает, что первая папка называется build-wrapper-win-x86
          $wrapperPath = Get-ChildItem -Path bw-temp\build-wrapper-win-x86 -Recurse -Filter "build-wrapper.exe" | Select-Object -First 1

          if ($wrapperPath -eq $null) {
            # Если не найдено, ищем еще раз без указания первой папки (на всякий случай)
            $wrapperPath = Get-ChildItem -Path bw-temp -Recurse -Filter "build-wrapper.exe" | Select-Object -First 1
          }

          if ($wrapperPath -eq $null) {
            throw "build-wrapper.exe not found. Check the output above for file paths."
          }

          # Сохраняем путь для использования в следующем шаге
          Write-Host "Found wrapper at: $($wrapperPath.FullName)"
          Write-Host "BUILD_WRAPPER_PATH=$($wrapperPath.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
      - name: Run Build Wrapper and MSBuild
        run: |
          # Используем сохраненный путь напрямую
          $wrapperPath = "${{ steps.find_wrapper.outputs.BUILD_WRAPPER_PATH }}"

          # Проверка на всякий случай
          if (-not (Test-Path $wrapperPath)) { throw "Build Wrapper not found at final path: $wrapperPath" }

          # Запускаем Build Wrapper, используя абсолютный путь и оборачивая msbuild
          # ★★★ ОЧЕНЬ ВАЖНО: Проверьте, что имя SLN-файла 'kursach.sln' правильное!
          & "$wrapperPath" --out-dir bw-output msbuild kursach.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64

      - name: SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=kursach
            -Dsonar.cfamily.build-wrapper-output=bw-output
            -Dsonar.sourceEncoding=UTF-8
