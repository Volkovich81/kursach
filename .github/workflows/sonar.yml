name: C++ SonarCloud Analysis (CMake/Linux)

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    name: SonarCloud Scan
    runs-on: ubuntu-latest

    env:
      BUILD_DIR: build_sonar
      BUILD_WRAPPER_OUTPUT: bw_output
      SONAR_SOURCES: . 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Build Wrapper
        # Это действие само устанавливает build-wrapper и делает его доступным в PATH
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v4

      - name: Install Qt Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qt6-base-dev cmake

      # 1. СБОРКА: Настраиваем CMake и запускаем Build Wrapper
      - name: Run CMake and Build Wrapper
        run: |
          echo "Starting CMake build and wrapping process..."
          rm -rf ${{ env.BUILD_DIR }}
          mkdir -p ${{ env.BUILD_DIR }}

          # 1. Настройка CMake
          cmake -S . -B ${{ env.BUILD_DIR }}

          # 2. Запуск Build Wrapper для отслеживания сборки
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUTPUT }} cmake --build ${{ env.BUILD_DIR }} --config Release
          ls -l ${{ env.BUILD_WRAPPER_OUTPUT }}/compile_commands.json
          echo "Build Wrapper successfully created output."

      # 2. АНАЛИЗ: Запуск Sonar Scanner
      - name: SonarCloud Scan CLI
        uses: SonarSource/sonarcloud-github-action@v4
        env:
         # Токен проекта, который вы получили ранее
          SONAR_TOKEN: 35aa0105af98d09b5c5973b5966a0a6e9a03dbf2 
          # Хост SonarCloud
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=volkovich81 
            -Dsonar.projectKey=kursach
            -Dsonar.cfamily.build-wrapper-output=${{ env.BUILD_WRAPPER_OUTPUT }}
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.sources=${{ env.SONAR_SOURCES }}
            -Dsonar.branch.name=main
            -Dsonar.branch.type=long
            -Dsonar.scm.disabled=true
