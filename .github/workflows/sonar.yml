name: C++ SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    # ✅ Используем Windows, чтобы собрать проект MSBuild
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java for SonarScanner
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup MSBuild (Visual Studio build environment)
        uses: microsoft/setup-msbuild@v2

      # 1. СКАЧИВАНИЕ И УСТАНОВКА ИНСТРУМЕНТОВ ВРУЧНУЮ
      - name: Download Build Wrapper and Sonar Scanner
        id: setup_tools
        run: |
          # 1. СКАЧИВАНИЕ И УСТАНОВКА BUILD WRAPPER
          $bw_url = "https://sonarcloud.io/static/cpp/build-wrapper-win-x86.zip"
          Invoke-WebRequest -Uri $bw_url -OutFile build-wrapper.zip

          # ✅ ИСПОЛЬЗУЕМ 7Z (7-ZIP) ВМЕСТО EXPAND-ARCHIVE ДЛЯ ГАРАНТИРОВАННОЙ РАСПАКОВКИ
          # Распаковываем в папку build-wrapper-temp
          & "C:\Program Files\7-Zip\7z.exe" x build-wrapper.zip -o"build-wrapper-temp" -y

          # Находим путь к Build Wrapper (самый надежный поиск после 7z)
          $wrapperPath = Get-ChildItem -Path build-wrapper-temp -Recurse -Filter "build-wrapper.exe" | Select-Object -First 1
          if ($wrapperPath -eq $null) { throw "build-wrapper.exe not found even after 7z extraction." }
          Write-Host "BW_PATH=$($wrapperPath.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          # 2. СКАЧИВАНИЕ И УСТАНОВКА SONAR SCANNER CLI
          $scanner_url = "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip"
          Invoke-WebRequest -Uri $scanner_url -OutFile sonar-scanner.zip
          & "C:\Program Files\7-Zip\7z.exe" x sonar-scanner.zip -o"." -y

          $scannerDir = Get-ChildItem -Path . -Filter "sonar-scanner-cli-*" -Directory | Select-Object -First 1
          if ($scannerDir -eq $null) { throw "Sonar Scanner directory not found." }
          Write-Host "SCANNER_PATH=$($scannerDir.FullName)\bin\sonar-scanner.bat" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      
      # 2. ШАГ СБОРКИ: Запуск Build Wrapper и MSBuild
      - name: Run Build Wrapper and MSBuild
        run: |
          $bwPath = "${{ steps.setup_tools.outputs.BW_PATH }}"
          
          # Запускаем Build Wrapper для отслеживания MSBuild
          & "$bwPath" --out-dir bw-output msbuild kursach.sln /t:Rebuild /p:Configuration=Release /p:Platform=x64

      # 3. ШАГ ОТПРАВКИ: Запуск анализа
      - name: SonarScanner Analysis
        run: |
          $scannerPath = "${{ steps.setup_tools.outputs.SCANNER_PATH }}"
          
          # Запускаем анализ
          & "$scannerPath" `
            -Dsonar.host.url=https://sonarcloud.io `
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} `
            -Dsonar.projectKey=kursach `
            -Dsonar.cfamily.build-wrapper-output=bw-output `
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
